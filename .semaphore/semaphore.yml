version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Setup
    task:
      jobs:
        - name: Containers setup
          commands:
            - checkout
            - make up
      prologue:
        commands:
          - 'git clone -b pece2.0 git@github.com:revagomes/drupal-pece.git'
      epilogue:
        always:
          commands:
            - echo 'Starting...'
        on_pass:
          commands:
            - echo 'Takalepau marko wèi!'
        on_fail:
          commands:
            - 'echo "Nooop :("'
      env_vars:
        - name: ENVIRONMENT
          value: prd
        - name: PROJECT_NAME
          value: pece2
        - name: PROJECT_BASE_URL
          value: localhost
        - name: DB_NAME
          value: drupal
        - name: DB_USER
          value: drupal
        - name: DB_PASSWORD
          value: password
        - name: DB_ROOT_PASSWORD
          value: password
        - name: DB_HOST
          value: mariadb
        - name: DB_DRIVER
          value: mysql
        - name: DB_PORT
          value: '3306'
        - name: MARIADB_TAG
          value: 10.9-3.23.0
        - name: DRUPAL_TAG
          value: '8'
        - name: NGINX_TAG
          value: 1.23-5.27.0
        - name: NGINX_VHOST_PRESET
          value: drupal8
        - name: PHP_TAG
          value: '8.1'
        - name: NODE_TAG
          value: '12.8'
        - name: FRONT_DIR
          value: ./src/front
    dependencies: []
  - name: Build
    dependencies:
      - Setup
    task:
      epilogue:
        always:
          commands:
            - echo 'Starting...'
        on_pass:
          commands:
            - echo 'Takalepau marko wèi!'
        on_fail:
          commands:
            - 'echo "Nooop :("'
      jobs:
        - name: Building project
          commands:
            - make build-dev
  - name: Installation
    dependencies:
      - Build
    task:
      epilogue:
        always:
          commands:
            - echo 'Starting...'
        on_pass:
          commands:
            - echo 'Takalepau marko wèi!'
        on_fail:
          commands:
            - 'echo "Nooop :("'
      jobs:
        - name: Installing PECE distro
          commands:
            - make site-install
  - name: DB Updates
    dependencies:
      - Installation
    task:
      epilogue:
        always:
          commands:
            - echo 'Starting...'
        on_pass:
          commands:
            - echo 'Takalepau marko wèi!'
        on_fail:
          commands:
            - 'echo "Nooop :("'
      jobs:
        - name: Starting DB updates
          commands:
            - make drush "updb -y"
  - name: Configuratino Sync
    dependencies:
      - DB Updates
    task:
      epilogue:
        always:
          commands:
            - echo 'Starting...'
        on_pass:
          commands:
            - echo 'Takalepau marko wèi!'
        on_fail:
          commands:
            - 'echo "Nooop :("'
      jobs:
        - name: 'Importing configuration '
          commands:
            - make drush "cim -y"
